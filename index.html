<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quáº£n lÃ½ Email Online - Auto Filter</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: sans-serif;
  background: #f0f2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  transition: background .5s, color .5s;
  color: initial;
}
body.duplicate-mode {
  background: #8b0000 !important;
  color: black !important;
}

textarea, input, button {
  font-size: 16px;
  width: 90%;
  max-width: 340px;
  margin-top: 10px;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

button {
  background: #007bff;
  color: white;
  border: none;
  cursor: pointer;
}

#deleteListButton { background: #0f4d0a; }
#copyButton {
  font-size: 20px;
  padding: 18px;
  width: 95%;
  max-width: 380px;
  background: #a728a7;
}
#clearLogsButton { background: #ffc107; color: black; }

#customToast {
  position: fixed;
  top: -100px;
  left: 0;
  width: 100%;
  background-color: #343a40;
  color: white;
  text-align: center;
  padding: 16px 10px;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
  z-index: 9999;
  transition: top .5s ease-in-out;
}
#customToast.show { top: 0; }
#customToast.error { background-color: #d93025; }
#customToast.success { background-color: #28a745; }
</style>
</head>

<body>

<div id="customToast"></div>

<h3>ğŸ“¨ Quáº£n lÃ½ danh sÃ¡ch Email Online</h3>

<textarea id="emailListInput" placeholder="DÃ¡n email, text rÃ¡c, phÃ¢n cÃ¡ch báº¥t ká»³"></textarea>
<button id="addListButton">â• ThÃªm Email</button>
<button id="deleteListButton">ğŸ—‘ï¸ XÃ³a Danh SÃ¡ch Email</button>

<input type="text" id="emailOutput" readonly placeholder="Email sáº½ xuáº¥t hiá»‡n á»Ÿ Ä‘Ã¢y">
<button id="manualCopyButton">ğŸ“‹ Copy</button>

<p id="count">ğŸ“Š Sá»‘ email cÃ²n láº¡i: 0</p>

<button id="clearLogsButton">ğŸ§¹ Clear Log Copy</button>
<button id="copyButton">ğŸ“‹ Láº¥y & Copy Email</button>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBArMthV7bSzHB8Xy48AT6jo4z1Xek51Nw",
  authDomain: "nhatxupro-c91a2.firebaseapp.com",
  databaseURL: "https://nhatxupro-c91a2-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();
const emailRef = db.ref("emails");
const copyLogsRef = db.ref("copyLogs");

let emailList = [];
let isDuplicateToast = false;

/* ========= DEVICE ID ========= */
let deviceId = localStorage.getItem("deviceId");
if (!deviceId) {
  deviceId = "dev_" + Math.random().toString(36).substring(2,10);
  localStorage.setItem("deviceId", deviceId);
}

/* ========= UTILS ========= */
function extractEmails(text) {
  const regex = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/gi;
  return [...new Set(text.match(regex) || [])];
}

function updateCount() {
  document.getElementById("count").textContent =
    `ğŸ“Š Sá»‘ email cÃ²n láº¡i: ${emailList.length}`;
}

/* ========= TOAST ========= */
function showToast(msg, type="") {
  const t = document.getElementById("customToast");
  t.textContent = msg;
  t.className = "show " + type;

  if (type !== "error") {
    setTimeout(() => {
      if (!isDuplicateToast) t.className = "";
    }, 4000);
  }
}

function showDuplicateToast(msg) {
  isDuplicateToast = true;
  document.body.classList.add("duplicate-mode");
  showToast(msg, "error");
}

function hideDuplicateToast() {
  isDuplicateToast = false;
  document.body.classList.remove("duplicate-mode");
  document.getElementById("customToast").className = "";
}

/* ========= COPY ========= */
function copyText(text) {
  navigator.clipboard.writeText(text)
    .then(() => showToast(`âœ… ÄÃ£ copy: ${text}`, "success"))
    .catch(() => showToast("âš ï¸ KhÃ´ng thá»ƒ copy", "error"));
}

/* ========= FIREBASE LISTENER ========= */
emailRef.on("value", snap => {
  const data = snap.val();
  emailList = data ? Object.values(data) : [];
  updateCount();
});

/* ========= ADD EMAIL ========= */
addListButton.onclick = () => {
  const emails = extractEmails(emailListInput.value);
  if (!emails.length) return showToast("âš ï¸ KhÃ´ng cÃ³ email há»£p lá»‡", "error");
  emails.forEach(e => emailRef.push(e));
  emailListInput.value = "";
  showToast(`âœ… ÄÃ£ thÃªm ${emails.length} email`, "success");
};

/* ========= DELETE LIST ========= */
deleteListButton.onclick = () => {
  if (!confirm("XÃ³a toÃ n bá»™ email?")) return;
  emailRef.remove();
  showToast("âœ… ÄÃ£ xÃ³a danh sÃ¡ch", "success");
};

/* ========= MANUAL COPY ========= */
manualCopyButton.onclick = () => {
  if (!emailOutput.value) return showToast("âš ï¸ KhÃ´ng cÃ³ email", "error");
  copyText(emailOutput.value);
};

/* ========= AUTO COPY + CHECK TRÃ™NG ========= */
copyButton.onclick = () => {
  hideDuplicateToast();

  if (!emailList.length)
    return showToast("âš ï¸ Danh sÃ¡ch Ä‘Ã£ háº¿t email", "error");

  const email = emailList[Math.floor(Math.random() * emailList.length)];
  emailOutput.value = email;
  copyText(email);

  emailRef.orderByValue().equalTo(email).limitToFirst(1).once("value", s => {
    s.forEach(c => c.ref.remove());
  });

  const now = Date.now();
  copyLogsRef.child(now + "_" + deviceId).set({ email, time: now, deviceId });

  copyLogsRef.orderByChild("time").startAt(now - 15000).once("value", snap => {
    const logs = snap.val() || {};
    for (const k in logs) {
      const log = logs[k];
      if (log.email === email && log.deviceId !== deviceId) {
        showDuplicateToast(`âš ï¸ Email "${email}" Ä‘Ã£ bá»‹ láº¥y bá»Ÿi thiáº¿t bá»‹ khÃ¡c!`);
        break;
      }
    }
  });
};

/* ========= CLEAR LOG ========= */
clearLogsButton.onclick = () => {
  copyLogsRef.remove();
  showToast("âœ… ÄÃ£ clear log", "success");
};
</script>

</body>
</html>
